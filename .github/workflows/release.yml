# 双分支自动打包发布工作流
#
# 版本号策略：
# - dev 分支：产生 1.0.23-alpha 格式（预发布版）
# - main 分支：产生 1.0.50 格式（正式版）
# - 其中 1.0 为 package.json 中的主版本，23/50 为构建号

name: Release

on:
  push:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9'

jobs:
  # ============================================
  # 准备版本号与分支判定
  # ============================================
  prepare:
    name: Prepare Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      full_version: ${{ steps.version.outputs.full_version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      release_tag: ${{ steps.version.outputs.release_tag }}
      release_name: ${{ steps.version.outputs.release_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate version
        id: version
        run: |
          # 读取 package.json 中的版本号 (如 1.0.0) 并提取前两位 (1.0)
          BASE_VERSION=$(node -p "let v=require('./package.json').version.split('.'); v.slice(0,2).join('.')")
          BUILD_NUMBER=${{ github.run_number }}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}

          if [ "$BRANCH_NAME" = "dev" ]; then
            # dev 分支：1.0.23-alpha
            FULL_VERSION="${BASE_VERSION}.${BUILD_NUMBER}-alpha"
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_tag=v${FULL_VERSION}" >> $GITHUB_OUTPUT
            echo "release_name=v${FULL_VERSION}" >> $GITHUB_OUTPUT
          else
            # main/master 分支：1.0.50
            FULL_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_tag=v${FULL_VERSION}" >> $GITHUB_OUTPUT
            echo "release_name=v${FULL_VERSION}" >> $GITHUB_OUTPUT
          fi

          echo "分支: $BRANCH_NAME"
          echo "完整版本: $FULL_VERSION"
          echo "version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
        shell: bash

  # ============================================
  # Windows 打包
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: prepare
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'backend/go.mod'
          cache-dependency-path: 'backend/go.sum'

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Precheck Go backend
        run: |
          cd backend
          go test ./...
        shell: bash

      - name: Generate icons
        run: |
          choco install imagemagick -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          cd electron/assets/icons
          foreach ($size in 16,24,32,48,64,128,256,512) {
            magick convert 991x991.png -resize ${size}x${size} ${size}x${size}.png
          }
          cd ..
          magick convert icons/991x991.png -define icon:auto-resize=256,128,64,48,32,16 icon.ico
        shell: pwsh

      - name: Build Go backend
        run: |
          New-Item -ItemType Directory -Force -Path electron/bin | Out-Null
          cd backend
          go build -buildvcs=false -ldflags "-s -w" -o ../electron/bin/knot-backend.exe .
        shell: pwsh

      - name: Build frontend
        run: pnpm run build

      # 更新 package.json 版本
      - name: Update version
        run: |
          pnpm version ${{ needs.prepare.outputs.full_version }} --no-git-tag-version --allow-same-version

      - name: Build Electron app
        run: pnpm exec electron-builder --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ needs.prepare.outputs.full_version }}
          path: dist-electron/*.exe
          retention-days: 3
          if-no-files-found: error

  # ============================================
  # Linux 打包 (Ubuntu Runner)
  # ============================================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 40

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git \
            imagemagick \
            libgtk-3-0 libnotify4 libnss3 libxss1 libxtst6 xdg-utils \
            libatspi2.0-0 libdrm2 libgbm1 libxcb-dri3-0 \
            dpkg fakeroot rpm build-essential

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'backend/go.mod'
          cache-dependency-path: 'backend/go.sum'

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile

      - name: Precheck Go backend
        run: |
          cd backend
          go test ./...

      - name: Generate icons
        run: |
          cd electron/assets/icons
          for size in 16 24 32 48 64 128 256 512; do
            convert 991x991.png -resize ${size}x${size} ${size}x${size}.png
          done
          cd ..
          convert icons/991x991.png -define icon:auto-resize=256,128,64,48,32,16 icon.ico

      - name: Build Go backend
        run: |
          cd backend
          mkdir -p ../electron/bin
          go build -buildvcs=false -ldflags "-s -w" -o ../electron/bin/knot-backend .
          chmod +x ../electron/bin/knot-backend
          ls -la ../electron/bin/

      - name: Build frontend
        run: pnpm run build

      - name: Update version
        run: |
          pnpm version ${{ needs.prepare.outputs.full_version }} --no-git-tag-version --allow-same-version

      - name: Build Electron app
        run: pnpm exec electron-builder --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-${{ needs.prepare.outputs.full_version }}
          path: |
            dist-electron/*.deb
            dist-electron/*.AppImage
          retention-days: 3
          if-no-files-found: error

  # ============================================
  # 发布到 GitHub Release
  # ============================================
  create-release:
    name: Create Release
    permissions:
      contents: write
    needs: [prepare, build-windows, build-linux]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release

      - name: Generate Release Notes
        uses: actions/github-script@v7
        id: generate-notes
        with:
          script: |
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: "${{ needs.prepare.outputs.release_tag }}",
              target_commitish: context.sha,
            });
            return data.body;

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "./release/**/*"
          tag: "${{ needs.prepare.outputs.release_tag }}"
          name: "${{ needs.prepare.outputs.release_name }}"
          body: |
            ## Knot 绳结 v${{ needs.prepare.outputs.full_version }}

            **构建分支**: ${{ github.ref_name }}
            **状态**: ${{ needs.prepare.outputs.is_prerelease == 'true' && 'Alpha 测试版' || '正式版' }}

            ### 更新内容
            ${{ steps.generate-notes.outputs.result }}
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: ${{ needs.prepare.outputs.is_prerelease == 'false' }}
          token: ${{ secrets.GITHUB_TOKEN }}
